<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Coffee Stained Map ☕</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body {
      background-color: #f8f9fa;
      font-family: system-ui, sans-serif;
    }

    #map {
      height: 80vh;
      width: 100%;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
    }

    #closest-tool {
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
    }

    #toggle-quarters {
      text-align: center;
      margin-top: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
    }

    select,
    input,
    button {
      margin-top: 5px;
    }

    h1 {
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div class="container py-3">
    <div class="text-center mb-3">
      <h1 class="text-dark">☕ Coffee Stained Map</h1>
      <p class="text-secondary">Explore cafés in Dublin — filter by quarter or find the nearest ones!</p>
    </div>

    <div class="row g-3">
      <!-- Sidebar Controls -->
      <div class="col-md-3">
        <div class="card shadow-sm p-3">
          <h5 class="text-center mb-3">Filters & Tools</h5>

          <label for="quarter-select" class="form-label fw-semibold">Filter by Quarter:</label>
          <select id="quarter-select" class="form-select mb-3">
            <option value="">-- Select Quarter --</option>
            <option value="1">North-West</option>
            <option value="2">North-East</option>
            <option value="3">South-West</option>
            <option value="4">South-East</option>
          </select>

          <div id="closest-tool">
            <h6 class="fw-semibold">Find Closest Cafés</h6>
            <label class="form-label">Latitude:</label>
            <input
              type="number"
              id="latInput"
              class="form-control"
              step="any"
              placeholder="53.34"
            />
            <label class="form-label">Longitude:</label>
            <input
              type="number"
              id="lngInput"
              class="form-control"
              step="any"
              placeholder="-6.26"
            />
            <button id="closest_cafes_button" class="btn btn-dark w-100 mt-2">
              Find
            </button>
          </div>

          <div id="toggle-quarters">
            <button> 
              Hide Quarters
            </button>
          </div>

          <div id="cafe-list" class="mt-3"></div>
        </div>
      </div>

      <!-- Map -->
      <div class="col-md-9">
        <div id="map"></div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // --- Initialize Map ---
    const map = L.map("map").setView([53.3498, -6.2603], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    // Layers
    let markersLayer = L.layerGroup().addTo(map);
    let quarterLayer = L.layerGroup().addTo(map);

   // --- Load Quarter Polygons ---
    fetch("/api/quarters/")
    .then(res => res.json())
    .then(geojson => {
        L.geoJSON(geojson, {
        style: {
            color: "#6f4e37",      // coffee brown
            weight: 2,
            fillColor: "#none",
            fillOpacity: 0
        },
        onEachFeature: (feature, layer) => {
            layer.bindPopup(`<b>${feature.properties.name}</b>`);
        }
        }).addTo(quarterLayer);
    })
    .catch(err => console.error("Error loading quarters:", err));

    // add cafes
    function addCafes(data) {
      markersLayer.clearLayers();
      console.log("Rendering cafés:", data.features?.length || 0);


      if (!data || data.type !== "FeatureCollection" || !Array.isArray(data.features)) {
        console.warn("Unexpected data format:", data);
        return;
      }

      data.features.forEach((f) => {
        let lat, lng;

        // GeoJSON coordinates
        if (f.geometry && f.geometry.type === "Point" && Array.isArray(f.geometry.coordinates)) {
          [lng, lat] = f.geometry.coordinates;
        }
        // WKT fallback
        else if (typeof f.geometry === "string") {
          const coordsText = f.geometry.replace("SRID=4326;POINT (", "").replace(")", "");
          [lng, lat] = coordsText.trim().split(/\s+/).map(Number);
        }

        if (lat && lng) {
          L.marker([lat, lng])
            .addTo(markersLayer)
            .on("click", () => {
              map.setView([lat, lng], 16);
            })
            .bindPopup(
              `<b>${f.properties?.name ?? "Unnamed Café"}</b><br>
              ${f.properties?.address ?? "No address"}<br>
              ⭐ ${f.properties?.rating ?? "N/A"}`
            );
        }
      });
    }

    // --- Filter by Quarter ---
    document.getElementById("quarter-select").addEventListener("change", async function () {
    const quarterId = this.value;
    const url = quarterId ? `/api/within_quarter/${quarterId}/` : "/api/cafes/";

    try {
        const res = await fetch(url);
        let data = await res.json();

        // Defensive parse if it's a string
        if (typeof data === "string") {
        try { data = JSON.parse(data); } catch (e) {
            console.error("Bad JSON from quarter endpoint:", e);
            return;
        }
        }

        console.log("Quarter response:", data);

        addCafes(data);

        if (!data.features?.length) {
        alert("No cafés found in this quarter.");
        }
    } catch (err) {
        console.error("Error loading cafes for quarter:", err);
    }
    });


    // --- Find Closest Cafés ---
    document.getElementById("closest_cafes_button").addEventListener("click", () => {
      const lat = parseFloat(document.getElementById("latInput").value);
      const lng = parseFloat(document.getElementById("lngInput").value);

      if (isNaN(lat) || isNaN(lng)) {
        alert("Please enter valid coordinates!");
        return;
      }

      fetch(`/api/closest_cafes/?lat=${lat}&lng=${lng}`)
        .then((res) => res.json())
        .then((fc) => {
          if (typeof fc === "string") {
            try {
              fc = JSON.parse(fc);
            } catch (e) {
              console.error("Invalid JSON:", e);
              return;
            }
          }

          addCafes(fc);

          // Add marker for search location
          L.marker([lat, lng], {
            icon: L.icon({
              iconUrl: "https://cdn-icons-png.flaticon.com/512/64/64113.png",
              iconSize: [25, 25],
            }),
          })
            .addTo(map)
            .bindPopup("Search location")
            .openPopup();

          map.setView([lat, lng], 14);

          // List closest cafés
          const listDiv = document.getElementById("cafe-list");
          listDiv.innerHTML = "<h6 class='fw-semibold mt-3'>Closest Cafés:</h6>";
          if (Array.isArray(fc.features)) {
            fc.features.forEach((f) => {
              listDiv.innerHTML += `
                <div class="border-bottom pb-2 mb-2">
                  <b>${f.properties?.name ?? "Unnamed Café"}</b><br>
                  ${f.properties?.address ?? "No address"}<br>
                  ⭐ ${f.properties?.rating ?? "N/A"}
                </div>`;
            });
          }
        })
        .catch((err) => console.error("Error loading closest cafes:", err));
    });

    // --- Load all cafés on initial map load ---
    window.addEventListener("load", () => {
      fetch("/api/cafes/")
        .then(res => res.json())
        .then(data => {
          if (typeof data === "string") {
            try { data = JSON.parse(data); } catch (e) {
              console.error("Bad JSON from /api/cafes/:", e);
              return;
            }
          }
          addCafes(data);
        })
        .catch(err => console.error("Error loading initial cafés:", err));
    });

    // Toggle quarters
    let quartersVisible = true;
    document.getElementById("toggle-quarters").addEventListener("click", () => {
      if(quartersVisible){
        map.removeLayer(quarterLayer);
        document.getElementById("toggle-quarters").textContent = "Show Quarters";
      }
      else{
        map.addLayer(quarterLayer);
        document.getElementById("toggle-quarters").textContent = "Hide Quarters";
      }
      quartersVisible = !quartersVisible;
    });

  </script>
</body>
</html>
