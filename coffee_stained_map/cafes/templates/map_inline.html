<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Coffee Stained Map ‚òï</title>

  <!-- leaflet css -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- bootstrap css -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />


  <style>
    body {
      background-color: #f8f9fa;
      font-family: system-ui, sans-serif;
    }

    #map {
      height: 80vh;
      width: 100%;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
    }

    #closest-tool, #radius-tool, #toggle-quarters {
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      margin-top: 10px;
    }

    select, input, button {
      margin-top: 5px;
      width: 100%;
    }

    h1 {
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div class="container py-3">
    <div class="text-center mb-3">
      <h1>‚òï Coffee Stained Map</h1>
    </div>

    <div class="row g-3">
      <!-- sidebar: contains map filters and tools -->
      <div class="col-md-3">
        <div class="card shadow-sm p-3">
          <h5 class="text-center mb-3">Filters & Tools</h5>

      <!-- county filter -->
      <label for="county-select">Filter by County:</label>
      <select id="county-select">
        <option value="">-- select county --</option>
      </select>

          <!-- toggle quarters -->
          <div id="toggle-counties">
            <button class="btn btn-outline-dark w-100" id="toggle-counties-button">Hide Counties</button>
          </div>

          <!-- zoom buttons -->
          <div id="toggle-zoom">
            <button class="btn btn-outline-dark w-100" id="toggle-zoom-in-button">Zoom In</button>
            <button class="btn btn-outline-dark w-100" id="toggle-zoom-out-button">Zoom Out</button>
          </div>

          <!-- get coordinates -->
          <div id="get-coordinates">
            <button class="btn btn-outline-dark w-100" id="get-coordinates-button">Get Coordinates</button>
            <!-- add popo up saying to click anywhere -->
          </div>

          <!-- find closest cafes -->
          <div id="closest-tool">
            <h6>Find Closest Caf√©s</h6>
            <label>latitude:</label>
            <input type="number" id="latInput" step="any" placeholder="53.34" />
            <label>longitude:</label>
            <input type="number" id="lngInput" step="any" placeholder="-6.26" />
            <button id="closest_cafes_button" class="btn btn-dark mt-2">find</button>
          </div>

          <!-- find cafes within radius -->
          <div id="radius-tool">
            <h6>Find Caf√©s Within Radius</h6>
            <label>Latitude:</label>
            <input id="latRadius" type="number" step="any" placeholder="53.34" />
            <label>Longitude:</label>
            <input id="lngRadius" type="number" step="any" placeholder="-6.26" />
            <label>Radius (meters):</label>
            <input id="radiusInput" type="number" placeholder="1000" />
            <button id="cafes_within_radius_button" class="btn btn-dark mt-2">find</button>
          </div>

          <!-- cafe list -->
          <div id="cafe-list" class="mt-3"></div>

          <div id="radius-list" class="mt-3"></div>
        </div>
      </div>

      <!-- map -->
      <div class="col-md-9">
        <div id="map"></div>
      </div>

      <div id="status">..</div>
      <div id="coords-display">..</div>
    </div>
  </div>

  <!-- leaflet js -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- bootstrap js -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

 
  <script>
  /* ---------------------------------------------
    MAP SETUP
  ---------------------------------------------- */
  const map = L.map("map").setView([53.34731, -6.258946], 11);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 20,
    attribution: "&copy; OpenStreetMap contributors",
  }).addTo(map);

  let markersLayer = L.markerClusterGroup().addTo(map);
  let countiesLayer = L.layerGroup().addTo(map);
  let radiusCircle = null;

  /* ---------------------------------------------
    LOAD COUNTY POLYGONS
  ---------------------------------------------- */
  fetch("/api/counties/")
    .then(res => res.json())
    .then(geojson => {

      // Draw counties
      L.geoJSON(geojson, {
        style: { color: "#ff8800", weight: 1, fillOpacity: 0 },
        onEachFeature: (feature, layer) => {
          const props = feature.properties;
          layer.bindPopup(`
            <b>${props.english_name}, ${props.province}</b><br>
            <i>${props.gaeilge_name}</i><br>
          `);
        }
      }).addTo(countiesLayer);

      // Populate dropdown
      const select = document.getElementById("county-select");
      geojson.features.forEach(f => {
        const opt = document.createElement("option");
        opt.value = f.properties.english_name;
        opt.textContent = f.properties.english_name;
        select.appendChild(opt);
      });
    })
    .catch(err => console.error("Error loading counties:", err));

  /* ---------------------------------------------
    HELPER: ADD CAF√âS TO MAP
  ---------------------------------------------- */
  function addCafes(data) {
    markersLayer.clearLayers();

    if (!data || data.type !== "FeatureCollection" || !Array.isArray(data.features)) {
      console.warn("Unexpected caf√© data format:", data);
      return;
    }

    const geoLayer = L.geoJSON(data, {
      pointToLayer: (_, latlng) => L.marker(latlng),
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        layer.bindPopup(`
          <b>${p.name ?? "Unnamed Caf√©"}</b><br>
          ${p.addr_street ?? ""}<br>
          ${p.addr_city ?? ""}<br>
          ${p.amenity ?? ""}
        `);
      }
    });

    markersLayer.addLayer(geoLayer);
  }

  /* ---------------------------------------------
    FILTER: BY COUNTY
  ---------------------------------------------- */
  document.getElementById("county-select").addEventListener("change", async function () {
    const countyName = this.value;

    if (!countyName) {
      fetch("/api/cafes_osm/")
        .then(r => r.json())
        .then(addCafes);
      return;
    }

    try {
      const res = await fetch(`/api/cafes_in_county/${countyName}/`);
      const data = await res.json();
      addCafes(data);

      if (!data.features?.length) {
        alert("No caf√©s found in this county.");
      }
    } catch (err) {
      console.error("Error loading county caf√©s:", err);
    }
  });

  /* ---------------------------------------------
    FIND CLOSEST CAF√âS
  ---------------------------------------------- */
  document.getElementById("closest_cafes_button").addEventListener("click", () => {
    const lat = parseFloat(document.getElementById("latInput").value);
    const lng = parseFloat(document.getElementById("lngInput").value);

    if (isNaN(lat) || isNaN(lng)) {
      alert("Enter valid coordinates");
      return;
    }

    fetch(`/api/closest_cafes/?lat=${lat}&lng=${lng}`)
      .then(res => res.json())
      .then(fc => {

        // Fix if API returns string JSON
        if (typeof fc === "string") {
          try { fc = JSON.parse(fc); } catch { return; }
        }

        addCafes(fc);

        // Mark search point
        L.marker([lat, lng], {
          icon: L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/64/64113.png",
            iconSize: [25, 25],
          })
        })
        .addTo(map)
        .bindPopup("Search location")
        .openPopup();

        map.setView([lat, lng], 20);

        // Sidebar list
        const list = document.getElementById("cafe-list");
        list.innerHTML = "<h6 class='fw-semibold mt-3'>Closest Caf√©s:</h6>";

        if (Array.isArray(fc.features)) {
          fc.features.forEach(f => {
            const p = f.properties;
            list.innerHTML += `
              <div class="border-bottom pb-2 mb-2">
                <b>${p.name ?? "Unnamed Caf√©"}</b><br>
                ${p.address ?? "No address"}<br>
                ‚≠ê ${p.rating ?? "N/A"}
                ${p.distance ? `<br>üìç ${p.distance} away` : ""}
              </div>`;
          });
        } else {
          list.innerHTML += "<p>No caf√©s found.</p>";
        }
      })
      .catch(err => console.error("Error loading closest caf√©s:", err));
  });

  /* ---------------------------------------------
    CAF√âS WITHIN RADIUS
  ---------------------------------------------- */
  document.getElementById("cafes_within_radius_button").addEventListener("click", async () => {
    const lat = parseFloat(document.getElementById("latRadius").value);
    const lng = parseFloat(document.getElementById("lngRadius").value);
    const radius = parseFloat(document.getElementById("radiusInput").value);

    if (isNaN(lat) || isNaN(lng) || isNaN(radius)) {
      alert("Please enter valid coordinates and radius");
      return;
    }

    // Remove previous circle
    map.eachLayer(layer => {
      if (layer instanceof L.Circle && layer.options.color === "blue") {
        map.removeLayer(layer);
      }
    });

    // Draw new circle
    radiusCircle = L.circle([lat, lng], {
      radius,
      color: "blue",
      fillOpacity: 0.1,
    }).addTo(map)
      .bindPopup(`Search area: ${radius} m`)
      .openPopup();

    map.setView([lat, lng], 14);

    try {
      const res = await fetch(`/api/cafes_within_radius/?lat=${lat}&lng=${lng}&radius=${radius}`);
      let data = await res.json();
      if (typeof data === "string") data = JSON.parse(data);

      const list = document.getElementById("radius-list");
      list.innerHTML = "<h6 class='fw-semibold mt-3'>Caf√©s Within Radius:</h6>";

      if (data.type === "FeatureCollection" && Array.isArray(data.features)) {
        addCafes(data);

        if (data.features.length) {
          data.features.forEach(f => {
            const p = f.properties;
            list.innerHTML += `
              <div class="border-bottom pb-2 mb-2">
                <b>${p.name ?? "Unnamed Caf√©"}</b><br>
                ${p.address ?? "No address"}<br>
                ‚≠ê ${p.rating ?? "N/A"}
              </div>`;
          });
        } else {
          list.innerHTML += "<p>No caf√©s found within this radius.</p>";
        }
      } else {
        list.innerHTML = "<p>Error loading caf√©s.</p>";
      }

    } catch (err) {
      console.error("Error loading caf√©s within radius:", err);
    }
  });

  /* ---------------------------------------------
    LOAD ALL CAF√âS ON START
  ---------------------------------------------- */
  window.addEventListener("load", () => {
    fetch("/api/cafes_osm/")
      .then(res => res.json())
      .then(data => {
        if (typeof data === "string") {
          try { data = JSON.parse(data); } catch { return; }
        }
        addCafes(data);
      })
      .catch(err => console.error("Error loading initial caf√©s:", err));
  });

  /* ---------------------------------------------
    TOGGLE COUNTY LAYER
  ---------------------------------------------- */
  let countiesVisible = true;
  document.getElementById("toggle-counties-button").addEventListener("click", () => {
    countiesVisible
      ? map.removeLayer(countiesLayer)
      : map.addLayer(countiesLayer);

    countiesVisible = !countiesVisible;

    document.getElementById("toggle-counties-button").textContent =
      countiesVisible ? "Hide Counties" : "Show Counties";
  });

  /* ---------------------------------------------
    ZOOM BUTTONS
  ---------------------------------------------- */
  document.getElementById("toggle-zoom-in-button").addEventListener("click", () => {
    map.setZoom(map.getZoom() + 1);
  });

  document.getElementById("toggle-zoom-out-button").addEventListener("click", () => {
    map.setZoom(map.getZoom() - 1);
  });

  /* ---------------------------------------------
    GET COORDINATES (NEXT CLICK)
  ---------------------------------------------- */
  document.getElementById("get-coordinates-button").addEventListener("click", () => {
    document.getElementById("status").textContent =
      "Click on the map to select coordinates.";

    function onMapClick(e) {
      const { lat, lng } = e.latlng;

      document.getElementById("coords-display").textContent =
        `Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}`;

      map.off("click", onMapClick);
      document.getElementById("status").textContent = "Coordinate selected.";
    }

    map.on("click", onMapClick);
  });

  </script>

</body>
</html>
