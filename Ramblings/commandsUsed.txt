Day One:
    Initiate App:
        django-admin startproject coffee_stained_map
        cd coffee_stained_map
        python manage.py startapp cafes

        -Added app to settings/installed_apps

    Setting Up Postgres:
        psql -U cianan
        CREATE DATABASE coffee_stained_map;
        \c coffee_stained_map
        CREATE EXTENSION postgis;

        -Added db info to settings.py

    -Creating a cafe model

    -Importing data from cafes.csv
        import csv
        from cafes.models import Cafe
        from django.contrib.gis.geos import Point

        with open('cafes.csv', newline='', encoding='utf-8') as csvfile:
            reader = csv.DictReader(csvfile)
            for row in reader:
                name = row['name']
                address = row['address']
                lon = float(row['longitude'])
                lat = float(row['latitude'])
                rating = float(row['rating'])
                location = Point(lon, lat)
                
                Cafe.objects.create(
                    name=name,
                    address=address,
                    location=location,
                    rating=rating
                )

import csv
from cafes.models import Cafe
from django.contrib.gis.geos import Point

with open('data/cafes.csv', newline='', encoding='utf-8') as csvfile:
    reader = csv.reader(csvfile)
    next(reader)  # skip the header row
    for row in reader:
        name, address, lon, lat, rating = row
        Cafe.objects.create(
            name=name,
            address=address,
            location=Point(float(lon), float(lat)),
            rating=float(rating)
        )

print("Sample cafes loaded!")

model hadnt properly migrated:  
    python manage.py makemigrations cafes
    python manage.py migrate

    verify:
        python manage.py shell
        from cafes.models import Cafe
        Cafe.objects.all() 

        it worked!

re-tried:
    import csv
    from cafes.models import Cafe
    from django.contrib.gis.geos import Point

    with open('data/cafes.csv', newline='', encoding='utf-8') as csvfile:
        reader = csv.reader(csvfile)
        next(reader)  # skip the header row
        for row in reader:
            name, address, lon, lat, rating = row
            Cafe.objects.create(
                name=name,
                address=address,
                location=Point(float(lon), float(lat)),
                rating=float(rating)
            )


    SAMPLE CAFE LOADED!

    verify data:    
        from cafes.models import Cafe
        from django.contrib.gis.geos import Point
        from django.contrib.gis.db.models.functions import Distance

        my_location = Point(-6.26, 53.34, srid=4326)

        nearby_cafes = (
            Cafe.objects
            .annotate(distance=Distance('location', my_location))
            .order_by('distance')
        )

        for cafe in nearby_cafes:
            print(cafe.name, cafe.distance.m)  # distance in meters


Configuring Rest Framework: 
    Adding to settings.py -> output will be geojson not json

Created serializer in cafes:
    converts python object into geojson structure

Created a view:
    readonly access for api endpoint. lets you read all cafes

Made cafe/urls.py:
    Django project has 2 levels of url routing - project/urls and app/urls
    Project one is first entry Point for when a web request comes in, deciding which app should handle it.
    Then each app has urls, which connects to specific urls within the app.

Run server:
    python manage.py runserver

    had issues with render. removed line from settings.py and it worked :)

    SUCCESS!

Now im going to try the cafes on a map using leaflet:
    making templates folder. creating maps.html
    creating static folder

Having issues with markers. geojson parsing wrong. cant understand why tbh.
had issue with urls.



Okay I had to change my structure to have all the js/css/template into one file for now as I was facing massive bugs. I may try to sepearate them again later.

I am going to try working on queries now.

    python manage.py shell  

    test get all cafes within 500m:
        from cafes.models import Cafe
        from django.contrib.gis.geos import Point
        from django.contrib.gis.db.models.functions import Distance

        # Reference point (example: Brew Hub)
        brew_hub = Cafe.objects.get(name="Brew Hub")
        buffer_distance = 500  # in meters

        # Get all cafÃ©s within 500m
        nearby_cafes = Cafe.objects.filter(
            location__distance_lte=(brew_hub.location, buffer_distance)
        )

        for cafe in nearby_cafes:
            print(cafe.name, cafe.location)

    making api for it:
        adding cafes near function to views

        had issues with views.py -> nearby = Cafe.objects.filter(location__distance_lte=(ref_point, D(m=distance)))
        for ages as I missed the double underscore!!!

        http://127.0.0.1:8000/api/nearby/?lat=53.334&lng=-6.264&distance=500

        returns:
        {"type":"FeatureCollection","features":[{"id":1,"type":"Feature","geometry":"SRID=4326;POINT (-6.264209 53.334211)","properties":{"name":"Brew Hub","address":"95 Some Street, Dublin","rating":4.8}},{"id":3,"type":"Feature","geometry":"SRID=4326;POINT (-6.26192 53.33741)","properties":{"name":"Bean Spot","address":"87 Some Street, Dublin","rating":3.2}},{"id":9,"type":"Feature","geometry":"SRID=4326;POINT (-6.257994 53.332188)","properties":{"name":"Bean Lounge","address":"7 Some Street, Dublin","rating":3.2}},{"id":24,"type":"Feature","geometry":"SRID=4326;POINT (-6.257863 53.333415)","properties":{"name":"Espresso Lounge","address":"24 Some Street, Dublin","rating":4.0}}]}

        rewrote and made closests_cafes

    going to make polygon models to use for "within" queries:
        going to make it a quarter and divide dublin by 4 quarters:
            quad 1(north-west): [53.376186,-6.308256],[53.38000, -6.265788],[53.34676, -6.318008],[53.34722, -6.259053]
            quad 2(north-east): [53.38000, -6.265788],[53.37549, -6.218826],[53.34722, -6.259053],[53.34537, -6.189664]
            quad 3(south-west): [53.34676, -6.318008],[53.34722, -6.259053],[53.32509, -6.306760],[53.32217, -6.265597]
            quad 4(south-east): [53.34722, -6.259053],[53.34537, -6.189664],[53.32217, -6.265597],[53.31330, -6.201768]

        python manage.py makemigrations
        python manage.py migrate

        register in admin.py

        create polygons:
            python manage.py runserver
                AttributeError: module 'django.contrib.admin' has no attribute 'OSMGeoAdmin' -> was missing: from django.contrib.gis import admin

            http://127.0.0.1:8000/admin/
            SuperUser:
            cianan
            ciananfinn@gmail.com
            Normal

            tried to add quarter, "add template doesnt exist"

            had to downgrade python. downgrading django to 4.2.14

    Got it made.

    Going to add coords directly.:
quad 1(north-west): [53.376186,-6.308256],[53.38000, -6.265788],[53.34676, -6.318008],[53.3467572, -6.3180080]

        coords = [
            (-6.308256, 53.376186),
            (-6.265788, 53.38000),
            (-6.318008, 53.34676),
            (-6.3180080, 53.3467572),
            (-6.308256, 53.376186), 
        ]

        poly = Polygon(coords)

        q = Quarter.objects.create(
            name="North-West",
            rank=1,
            boundary=poly
        )



chat made this :

from cafes.models import Quarter
from django.contrib.gis.geos import Polygon

# Quad 1 - North-West
quad1_coords = [
    (-6.308256, 53.376186),
    (-6.265788, 53.380000),
    (-6.259053, 53.34722),
    (-6.318008, 53.346760),
    (-6.308256, 53.376186)  # close polygon
]
quad1 = Quarter(name='North-West', rank=1, boundary=Polygon(quad1_coords))
quad1.save()

# Quad 2 - North-East
quad2_coords = [
    (-6.265788, 53.380000),
    (-6.218826, 53.37549),
    (-6.189664, 53.34537),
    (-6.259053, 53.34722),
    (-6.265788, 53.380000)
]
quad2 = Quarter(name='North-East', rank=2, boundary=Polygon(quad2_coords))
quad2.save()

# Quad 3 - South-West
quad3_coords = [
    (-6.318008, 53.346760),
    (-6.259053, 53.34722),
    (-6.265597, 53.32217),
    (-6.306760, 53.32509),
    (-6.318008, 53.346760)
]
quad3 = Quarter(name='South-West', rank=3, boundary=Polygon(quad3_coords))
quad3.save()

# Quad 4 - South-East
quad4_coords = [
    (-6.259053, 53.34722),
    (-6.189664, 53.34537),
    (-6.201768, 53.31330),
    (-6.265597, 53.32217),
    (-6.259053, 53.34722)
]
quad4 = Quarter(name='South-East', rank=4, boundary=Polygon(quad4_coords))
quad4.save()


can now filter by quarter.

adding visualisation of quarters to make it easier.

PYTHON ENV:
source .venv311/bin/activate

OKAY WE ARE BACK FINALLY

GOING TO TRY AND FIX THE FACT THAT THE MARKERS DONT SHOW ON FIRST LOAD, BUT DO AFTER.

good :)

going to add togle for showing quads


made index for cafe:
    (.venv311) cianan@Cianans-MacBook-Pro coffee_stained_map % python manage.py makemigrations
    python manage.py migrate

    Migrations for 'cafes':
    cafes/migrations/0003_cafe_cafe_location_gist.py
        - Create index cafe_location_gist on field(s) location of model cafe
    Operations to perform:
    Apply all migrations: admin, auth, cafes, contenttypes, sessions
    Running migrations:
    Applying cafes.0003_cafe_cafe_location_gist... OK

    verified:
        (.venv311) cianan@Cianans-MacBook-Pro coffee_stained_map % psql -U webmapping -d coffee_stained_map

        psql (15.14 (Homebrew), server 17.6 (Homebrew))
        WARNING: psql major version 15, server major version 17.
                Some psql features might not work.
        Type "help" for help.

        coffee_stained_map=# \d cafes_cafe;
                                        Table "public.cafes_cafe"
        Column  |          Type          | Collation | Nullable |             Default              
        ----------+------------------------+-----------+----------+----------------------------------
        id       | bigint                 |           | not null | generated by default as identity
        name     | character varying(100) |           | not null | 
        address  | character varying(200) |           | not null | 
        location | geometry(Point,4326)   |           | not null | 
        rating   | double precision       |           | not null | 
        Indexes:
            "cafes_cafe_pkey" PRIMARY KEY, btree (id)
            "cafe_location_gist" gist (location)
            "cafes_cafe_location_7da5c60f_id" gist (location)

